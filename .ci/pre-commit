#!/usr/bin/env bash
# Git pre-commit hook - runs quick checks before commit

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

echo "ğŸ” Running pre-commit checks..."
echo ""

# Quick format check
echo "â–¶ Checking formatting..."
if ! cargo fmt --all -- --check >/dev/null 2>&1; then
    echo "âŒ Code is not formatted. Run 'cargo fmt' to fix."
    echo "   Attempting to auto-format..."
    cargo fmt --all
    echo "âœ… Auto-formatted. Please review changes and commit again."
    exit 1
fi
echo "âœ… Formatting OK"

# Quick build check
echo "â–¶ Checking build..."
if ! cargo check --all-targets >/dev/null 2>&1; then
    echo "âŒ Build failed. Fix errors before committing."
    exit 1
fi
echo "âœ… Build OK"

# Quick test on core modules
echo "â–¶ Running quick tests..."
if ! cargo test --lib --release -- --test-threads=4 >/dev/null 2>&1; then
    echo "âŒ Tests failed. Fix tests before committing."
    exit 1
fi
echo "âœ… Tests OK"

echo ""
echo "âœ… Pre-commit checks passed!"
